<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reino do Caos - Eventos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0c0c1e 0%, #1a1a3e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 10px;
            border: 1px solid #444;
        }
        .header h1 {
            color: #ffd700;
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 5px;
        }
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .player-card {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #555;
        }
        .player-name {
            font-size: 1.8rem;
            color: #ffd700;
        }
        .player-class {
            font-size: 1.2rem;
            color: #4cc9f0;
        }
        .player-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: rgba(40, 40, 70, 0.7);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        .events-card {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #555;
            text-align: center;
        }
        .events-header h2 {
            color: #ffd700;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        .explore-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(76, 201, 240, 0.5);
        }
        .explore-btn:hover { transform: scale(1.05); }
        .explore-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading span {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4cc9f0;
            margin: 0 5px;
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        #errorContainer {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>REINO DO CAOS</h1>
            <p>EXPLORA√á√ÉO E EVENTOS</p>
        </div>
        <div id="errorContainer"></div>
        <div class="content">
            <div class="player-card">
                <div class="player-name" id="playerName">Carregando...</div>
                <div class="player-class" id="playerClass">N√≠vel: --</div>
                <div class="player-stats">
                    <div class="stat-card">
                        <div class="stat-label">ENERGIA</div>
                        <div class="stat-value" id="playerEnergy">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">EXPERI√äNCIA</div>
                        <div class="stat-value" id="playerXP">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">SA√öDE</div>
                        <div class="stat-value" id="playerHealth">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">DINHEIRO</div>
                        <div class="stat-value" id="playerMoney">--</div>
                    </div>
                </div>
            </div>
            <div class="events-card">
                <div class="events-header">
                    <h2>EXPLORAR TERRIT√ìRIO</h2>
                </div>
                <button class="explore-btn" id="exploreBtn">
                    <div style="font-size:3rem;margin-bottom:10px;">üó∫Ô∏è</div>
                    EXPLORAR
                </button>
                <div class="loading" id="loadingIndicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup 1: Encontro Inimigo -->
    <div id="enemyEncounterModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#1a1a3e; padding:25px; border-radius:12px; text-align:center; max-width:500px; border:1px solid #e74c3c;">
            <h2 style="color:#e74c3c; margin-bottom:15px;">Encontro Perigoso!</h2>
            <p id="enemyEncounterDesc" style="margin-bottom:25px; line-height:1.5;"></p>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button id="fleeBtn" style="background:#555; color:white; border:none; padding:12px 24px; border-radius:6px; font-weight:bold;">Correr</button>
                <button id="fightBtn" style="background:linear-gradient(135deg,#ff6b6b,#ee5a24); color:white; border:none; padding:12px 24px; border-radius:6px; font-weight:bold;">Encarar</button>
            </div>
        </div>
    </div>

    <!-- Popup 2: Resultado -->
    <div id="resultModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#1a1a3e; padding:25px; border-radius:12px; text-align:center; max-width:500px; border:1px solid #ffd700;">
            <h2 id="resultTitle" style="color:#ffd700; margin-bottom:15px;"></h2>
            <p id="resultDesc" style="margin-bottom:20px; line-height:1.5;"></p>
            <div id="resultReward" style="margin-bottom:20px; font-weight:bold;"></div>
            <button id="resultCloseBtn" style="background:linear-gradient(135deg,#4cc9f0,#4361ee); color:white; border:none; padding:12px 24px; border-radius:6px; font-weight:bold;">
                OK
            </button>
        </div>
    </div>

    <script>
        let currentPlayer = null;
        let currentEvent = null;
        let isProcessing = false;

        // üîÅ Sincroniza entre abas
        window.addEventListener('storage', (e) => {
            if (e.key === 'playerData') {
                const updated = JSON.parse(e.newValue || '{}');
                Object.assign(currentPlayer, updated);
                updateUI();
            }
        });

        async function init() {
            if (!localStorage.getItem('idusuario')) {
                alert('Fa√ßa login primeiro.');
                window.location.href = './index.html';
                return;
            }
            currentPlayer = await GAME.ensurePlayerData();
            await GAME.loadEvents();
            updateUI();
        }

        function updateUI() {
            if (!currentPlayer) return;
            document.getElementById('playerName').textContent = currentPlayer.nome;
            document.getElementById('playerClass').textContent = `N√≠vel: ${currentPlayer.level}`;
            document.getElementById('playerEnergy').textContent = currentPlayer.energia;
            document.getElementById('playerXP').textContent = currentPlayer.exp;
            document.getElementById('playerHealth').textContent = currentPlayer.vida;
            document.getElementById('playerMoney').textContent = currentPlayer.ouro;

            // Atualiza bot√£o de explorar
            const btn = document.getElementById('exploreBtn');
            if (btn) {
                btn.disabled = isProcessing || currentPlayer.energia < 10;
            }
        }

        function showEnemyEncounter(event) {
            document.getElementById('enemyEncounterDesc').textContent = event.descricao || 'Um inimigo apareceu!';
            document.getElementById('enemyEncounterModal').style.display = 'flex';
        }

        function showResult(title, description, reward = '', isSuccess = true) {
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultDesc').textContent = description;
            const rewardEl = document.getElementById('resultReward');
            if (reward) {
                rewardEl.textContent = reward;
                rewardEl.style.color = isSuccess ? '#2ecc71' : '#e74c3c';
                rewardEl.style.display = 'block';
            } else {
                rewardEl.style.display = 'none';
            }
            document.getElementById('resultModal').style.display = 'flex';
        }

        async function handleExplore() {
            if (isProcessing) return;
            isProcessing = true;

            const btn = document.getElementById('exploreBtn');
            const loading = document.getElementById('loadingIndicator');
            const errorEl = document.getElementById('errorContainer');

            btn.disabled = true;
            loading.style.display = 'block';
            errorEl.textContent = '';

            try {
                const result = await GAME.explore(currentPlayer);
                currentEvent = result.event;

                if (result.type === 'enemy') {
                    showEnemyEncounter(result.event);
                } else {
                    const bonusResult = await GAME.resolveBonusEvent(currentPlayer, result.event);
                    currentPlayer = JSON.parse(localStorage.getItem('playerData'));
                    updateUI();

                    let msg = `+${bonusResult.xp} XP | +${bonusResult.energia} Energia`;
                    if (bonusResult.bonusReward) {
                        if (bonusResult.bonusReward.type === 'npc') {
                            msg += `\n\nüåü Novo aliado: ${bonusResult.bonusReward.name}!`;
                        } else {
                            msg += `\n\nüéÅ Novo item: ${bonusResult.bonusReward.name}!`;
                        }
                    }
                    showResult('Evento Especial!', result.event.msg || 'Voc√™ encontrou algo incr√≠vel!', msg, true);
                }
            } catch (err) {
                errorEl.textContent = err.message;
                setTimeout(() => errorEl.textContent = '', 4000);
            } finally {
                loading.style.display = 'none';
                if (!currentEvent) {
                    isProcessing = false;
                    updateUI(); // Garante que o bot√£o seja habilitado
                }
            }
        }

        async function handleFight(willFight) {
            document.getElementById('enemyEncounterModal').style.display = 'none';

            try {
                const result = await GAME.resolveEnemyEvent(currentPlayer, currentEvent, willFight);
                currentPlayer = JSON.parse(localStorage.getItem('playerData'));
                updateUI();

                // ‚úÖ Verifica se energia acabou
                if (currentPlayer.energia <= 0) {
                    showResult('Energia Esgotada!', 'Sua energia acabou! Voc√™ precisa descansar.', '', false);
                    document.getElementById('resultCloseBtn').onclick = () => {
                        window.location.href = './homeplayer.html';
                    };
                    return;
                }

                if (result.type === 'flee') {
                    showResult('Fuga!', 'Voc√™ escapou, mas perdeu 5 de energia.');
                } else {
                    const title = result.success ? 'Vit√≥ria!' : 'Derrota!';
                    const desc = result.success ? currentEvent.msgsucess : currentEvent.msgfail;
                    const reward = result.success 
                        ? `+${result.xp} XP | -10 Energia`
                        : `+${result.xp} XP | -10 Energia | -${result.vidaPerdida} Vida`;
                    showResult(title, desc || '', reward, result.success);
                }
            } catch (err) {
                document.getElementById('errorContainer').textContent = 'Erro ao processar combate.';
                setTimeout(() => document.getElementById('errorContainer').textContent = '', 4000);
            } finally {
                currentEvent = null;
                isProcessing = false;
                updateUI(); // Libera o bot√£o
            }
        }

        document.getElementById('resultCloseBtn').addEventListener('click', () => {
            document.getElementById('resultModal').style.display = 'none';
            // Se ainda tiver energia, permite continuar
            if (currentPlayer && currentPlayer.energia > 0) {
                isProcessing = false;
                updateUI();
            }
        });

        document.addEventListener('DOMContentLoaded', init);
        document.getElementById('exploreBtn').addEventListener('click', handleExplore);
        document.getElementById('fleeBtn').addEventListener('click', () => handleFight(false));
        document.getElementById('fightBtn').addEventListener('click', () => handleFight(true));
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./game-core.js"></script>
</body>
</html>