<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala dos Aventureiros - Reino do Caos</title>
    <style>
        /* üé® ESTILOS ID√äNTICOS AO SEU PROJETO */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        body {
            background: linear-gradient(135deg, #0d1b2a, #1b263b, #415a77);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow: auto;
            padding: 20px;
        }
        .game-container {
            background-color: rgba(13, 27, 42, 0.95);
            border: 4px solid #778da9;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
            text-align: center;
            width: 95%;
            max-width: 800px;
            position: relative;
            overflow: hidden;
        }
        .player-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 0 0 15px 0;
            padding: 15px;
            background: rgba(26, 52, 76, 0.7);
            border-radius: 8px;
            border: 1px solid #468faf;
        }
        .player-stat {
            text-align: center;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #e0e1dd;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 5px #ff9900;
        }
        .game-btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            background: linear-gradient(to bottom, #2a6f97, #01497c);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 0 #013a63;
            border: 2px solid #468faf;
            min-width: 140px;
        }
        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #013a63;
        }
        .game-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #013a63;
        }
        .game-btn.primary {
            background: linear-gradient(to bottom, #ff6b6b, #cc0000);
            box-shadow: 0 4px 0 #990000;
            border: 2px solid #ff3333;
        }
        .game-btn.back {
            background: linear-gradient(to bottom, #6b8c42, #4a6429);
            box-shadow: 0 4px 0 #3a5120;
            border: 2px solid #8bb454;
        }
        .message-display {
            font-size: 1.1rem;
            color: #00ccff;
            margin: 10px 0;
            text-shadow: 0 0 5px #0077b6;
            min-height: 24px;
            padding: 8px;
            background: rgba(26, 52, 76, 0.5);
            border-radius: 5px;
            border: 1px solid #468faf;
        }
        .error-message {
            color: #ff6b6b;
            background: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ff6b6b;
        }

        /* === CHAT ESTILOS === */
        .chat-container {
            background: #000;
            border: 3px solid #01497c;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .chat-messages {
            text-align: left;
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 10px;
            min-height: 30px;
        }
        .chat-message {
            margin-bottom: 6px;
            padding: 4px 8px;
            background: rgba(26, 52, 76, 0.5);
            border-radius: 5px;
            border-left: 3px solid #ffcc00;
            color: #e0e1dd;
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
        }
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #468faf;
            background: #1a2430;
            color: white;
            font-family: 'Courier New', monospace;
        }
        .chat-input:focus {
            outline: none;
            border-color: #ffcc00;
        }

        /* üÜï ESTILOS ESPEC√çFICOS DA SALA ONLINE */
        .sala-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .sala-imagem {
            background: #000;
            border: 3px solid #01497c;
            border-radius: 10px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        .sala-imagem img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .forca-sala {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #ffcc00;
            color: #ffcc00;
            font-weight: bold;
            text-shadow: 0 0 5px #ff9900;
        }
        .sala-jogadores {
            background: #000;
            border: 3px solid #01497c;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
        }
        .sala-titulo {
            color: #ffcc00;
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-shadow: 0 0 5px #ff9900;
            border-bottom: 2px solid #ffcc00;
            padding-bottom: 5px;
        }
        .jogadores-lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .jogador-card {
            background: rgba(26, 52, 76, 0.7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #468faf;
            text-align: left;
        }
        .jogador-nome {
            font-weight: bold;
            color: #ffcc00;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        .jogador-classe {
            color: #e0e1dd;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-style: italic;
        }
        .jogador-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }
        .status-online {
            color: #00ff00;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .online-dot {
            background: #00ff00;
            box-shadow: 0 0 5px #00ff00;
        }
        .loading {
            color: #00ccff;
            font-size: 1.2rem;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .player-info {
                grid-template-columns: repeat(2, 1fr);
            }
            .jogadores-lista {
                grid-template-columns: 1fr;
            }
            .sala-imagem {
                height: 250px;
            }
        }
        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
            }
            .player-info {
                grid-template-columns: 1fr;
            }
            .sala-imagem {
                height: 200px;
            }
            .game-btn {
                padding: 10px 20px;
                font-size: 1rem;
                min-width: 120px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="game-core.js"></script>
</head>
<body>
    <div class="game-container">
        <div class="player-info" id="player-info">
            <div class="player-stat">
                <div class="stat-label">Aventureiro</div>
                <div class="stat-value" id="player-name">Carregando...</div>
            </div>
            <div class="player-stat">
                <div class="stat-label">Jogadores Online</div>
                <div class="stat-value" id="online-count">0</div>
            </div>
            <div class="player-stat">
                <div class="stat-label">For√ßa da Sala</div>
                <div class="stat-value" id="forca-total">0</div>
            </div>
        </div>
        <div class="sala-container">
            <!-- √ÅREA DA IMAGEM COM FOR√áA DA SALA -->
            <div class="sala-imagem">
                <img src="https://images.unsplash.com/photo-1534423861386-85a16f5d13fd?w=400&h=300&fit=crop" 
                     alt="Grande Sal√£o do Reino" 
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMWIyYzNkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkdyYW5kZSBTYWzDg28gZG8gUmVpbm88L3RleHQ+PC9zdmc+'">
                <div class="forca-sala" id="forca-sala-badge">
                    üí™ For√ßa: <span id="forca-sala-valor">0</span>
                </div>
            </div>

            <!-- ‚úÖ CHAT √öNICO -->
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message">üí¨ Carregando hist√≥rico...</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" class="chat-input" placeholder="Digite sua mensagem..." maxlength="100">
                    <button class="game-btn" style="padding: 8px 12px; font-size: 0.9rem;" onclick="enviarMensagem()">Enviar</button>
                </div>
            </div>

            <!-- √ÅREA DOS JOGADORES ONLINE -->
            <div class="sala-jogadores">
                <div class="sala-titulo">üè∞ Aventureiros no Sal√£o</div>
                <div class="jogadores-lista" id="jogadores-lista">
                    <div class="loading">üîÑ Carregando aventureiros...</div>
                </div>
            </div>
        </div>
        <div class="message-display" id="message">
            Conectado √† sala dos aventureiros. Jogadores online aparecer√£o aqui!
        </div>
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
            <button class="game-btn back" onclick="voltarParaReino()">‚Üê Voltar ao Reino</button>
            <button class="game-btn primary" onclick="atualizarJogadores()">üîÑ Atualizar Lista</button>
        </div>
    </div>
    <script>
        // ‚úÖ REMOVIDO: chamada a GAME.requireAuth() ‚Äî voc√™ j√° valida com localStorage

        async function buscarJogadoresOnline() {
            try {
                const { data: usuarios, error } = await supabase
                    .from('usuario')
                    .select('idusuario, nomeusuario, statusonline')
                    .eq('statusonline', true)
                    .order('nomeusuario', { ascending: true });
                if (error) throw error;
                if (!usuarios || usuarios.length === 0) {
                    return { jogadores: [], forcaTotal: 0 };
                }
                let forcaTotal = 0;
                const jogadoresCompletos = [];
                for (const usuario of usuarios) {
                    const { data: playerData } = await supabase
                        .from('player')
                        .select('nome, classe, forcaini')
                        .eq('idusuariofk', usuario.idusuario)
                        .single();
                    const player = playerData || { 
                        nome: usuario.nomeusuario, 
                        classe: 'Aventureiro',
                        forcaini: 10
                    };
                    forcaTotal += Number(player.forcaini) || 10;
                    jogadoresCompletos.push({
                        usuario: usuario,
                        player: player
                    });
                }
                return { jogadores: jogadoresCompletos, forcaTotal };
            } catch (error) {
                console.error('Erro na busca de jogadores:', error);
                return { jogadores: [], forcaTotal: 0 };
            }
        }

        async function atualizarMeuStatusOnline() {
            try {
                const idusuario = localStorage.getItem('idusuario');
                if (!idusuario) return;
                await supabase
                    .from('usuario')
                    .update({ statusonline: true })
                    .eq('idusuario', idusuario);
            } catch (error) {
                console.warn('Erro ao atualizar status online:', error);
            }
        }

        async function carregarDadosPlayer() {
            try {
                // ‚úÖ REMOVIDO: GAME.requireAuth()
                const idusuario = localStorage.getItem('idusuario');
                if (!idusuario) {
                    alert('Fa√ßa login primeiro.');
                    window.location.href = './index.html';
                    return null;
                }
                const playerData = await GAME.ensurePlayerData();
                if (!playerData) throw new Error('Dados do player n√£o encontrados');
                document.getElementById('player-name').textContent = playerData.nomeplayer || 'Aventureiro';
                await atualizarMeuStatusOnline();
                return playerData;
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('player-name').textContent = 'Aventureiro';
                document.getElementById('message').className = 'error-message';
                document.getElementById('message').textContent = 'Erro ao carregar dados. Modo offline.';
                return null;
            }
        }

        async function exibirJogadoresOnline() {
            const listaElement = document.getElementById('jogadores-lista');
            listaElement.innerHTML = '<div class="loading">üîÑ Buscando aventureiros...</div>';
            try {
                const { jogadores, forcaTotal } = await buscarJogadoresOnline();
                document.getElementById('forca-total').textContent = forcaTotal;
                document.getElementById('forca-sala-valor').textContent = forcaTotal;

                if (jogadores.length === 0) {
                    listaElement.innerHTML = `<div style="text-align: center; color: #e0e1dd; padding: 20px;">üèúÔ∏è Nenhum aventureiro online...</div>`;
                    document.getElementById('online-count').textContent = '0';
                    return;
                }

                let html = '';
                jogadores.forEach(item => {
                    const nome = item.player?.nome || item.usuario.nomeusuario || 'Aventureiro';
                    const classe = item.player?.classe || 'Aventureiro';
                    const forca = item.player?.forcaini || '?';
                    html += `
                        <div class="jogador-card">
                            <div class="jogador-nome">${nome}</div>
                            <div class="jogador-classe">${classe}</div>
                            <div class="jogador-status">
                                <span class="status-dot online-dot"></span>
                                <span class="status-online">Online ‚Ä¢ For√ßa: ${forca}</span>
                            </div>
                        </div>
                    `;
                });
                listaElement.innerHTML = html;
                document.getElementById('online-count').textContent = jogadores.length;

                let mensagemForca = forcaTotal > 100 ? '‚ö° Poder impressionante nesta sala!' :
                                       forcaTotal > 50  ? 'üí™ For√ßa consider√°vel reunida!' :
                                                           'üåü Sala aguardando mais her√≥is...';
                document.getElementById('message').textContent = 
                    `üéâ ${jogadores.length} aventureiro(s) | For√ßa total: ${forcaTotal} | ${mensagemForca}`;
            } catch (error) {
                console.error('Erro em exibirJogadoresOnline:', error);
                listaElement.innerHTML = `<div class="error-message">‚ùå Erro ao carregar lista.</div>`;
            }
        }

        async function atualizarJogadores() {
            document.getElementById('message').textContent = 'üîÑ Atualizando lista de aventureiros...';
            await exibirJogadoresOnline();
        }

        // ‚úÖ REMOVIDA A DUPLICA√á√ÉO DA FUN√á√ÉO iniciarOuvinteChat

        async function enviarMensagem() {
            const input = document.getElementById('chat-input');
            const mensagem = input.value.trim();
            if (!mensagem) return;

            const idusuario = localStorage.getItem('idusuario');
            if (!idusuario) {
                alert('Voc√™ precisa estar logado para enviar mensagens.');
                return;
            }

            try {
                const playerData = await GAME.ensurePlayerData();
                const nome = playerData?.nomeplayer || 'Aventureiro';

                const { error } = await supabase.from('chat_mensagens').insert({
                    usuario_id: idusuario,
                    nome: nome,
                    mensagem: mensagem
                });

                if (error) throw error;
                input.value = '';
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                alert('N√£o foi poss√≠vel enviar a mensagem.');
            }
        }

        async function carregarMensagensChat() {
            try {
                const { data: mensagens, error } = await supabase
                    .from('chat_mensagens')
                    .select('nome, mensagem, created_at')
                    .order('created_at', { ascending: true })
                    .limit(30);

                const chatBox = document.getElementById('chat-messages');
                if (error) throw error;

                if (!mensagens || mensagens.length === 0) {
                    chatBox.innerHTML = '<div class="chat-message">üí¨ Bem-vindo ao chat da Sala!</div>';
                    return;
                }

                chatBox.innerHTML = mensagens.map(m => 
                    `<div class="chat-message"><strong>${m.nome}:</strong> ${m.mensagem}</div>`
                ).join('');
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                console.error('Erro ao carregar chat:', error);
                document.getElementById('chat-messages').innerHTML = 
                    '<div class="chat-message">‚ö†Ô∏è Chat indispon√≠vel no momento.</div>';
            }
        }

        function iniciarOuvinteChat() {
            const chatBox = document.getElementById('chat-messages');
            supabase
                .channel('chat-sala')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'chat_mensagens'
                }, payload => {
                    const m = payload.new;
                    const msgEl = document.createElement('div');
                    msgEl.className = 'chat-message';
                    msgEl.innerHTML = `<strong>${m.nome}:</strong> ${m.mensagem}`;
                    chatBox.appendChild(msgEl);
                    chatBox.scrollTop = chatBox.scrollHeight;
                })
                .subscribe();
        }

        function voltarParaReino() {
            if (window.GAME && window.GAME.config) {
                window.location.href = window.GAME.config.homeUrl;
            } else {
                window.location.href = './homeplayer.html';
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('‚úÖ Inicializando Sala dos Aventureiros...');
            await carregarDadosPlayer();
            await exibirJogadoresOnline();
            await carregarMensagensChat();
            iniciarOuvinteChat();
            setInterval(exibirJogadoresOnline, 30000);
        });

        window.addEventListener('beforeunload', async function() {
            const idusuario = localStorage.getItem('idusuario');
            if (!idusuario) return;
            try {
                await supabase
                    .from('usuario')
                    .update({ statusonline: false })
                    .eq('idusuario', idusuario);
            } catch (error) {
                console.warn('Erro ao atualizar status offline:', error);
            }
        });
    </script>
</body>
</html>